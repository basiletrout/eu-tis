
alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"X-Forwarded-For header buffer overflow - Length > 50";

    flow: to_server, established;
    http_header:field x-forwarded-for;
    pcre:"/.{51,}/i";

    classtype:Ivanti_Policy_Secure--CVE-2025-22457;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245701;
    rev:2;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"X-Forwarded-For suspicious patterns";

    flow: to_server, established;
    http_header:field x-forwarded-for;

    # Detection of suspicious patterns that are clearly not valid IPs
    # Examples detected: very long strings, obvious non-IP patterns, mixed formats
    # Simple and robust - avoids complex IP validation that belongs in application layer
    # Matches: excessive length, repeated patterns, obvious malformed content

    pcre:"/(.{100,}|(\d+\.){10,}|[0-9]{10,}|\.{5,})/i";

    classtype:HTTP_header_overflow;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245702;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:X-Forwarded-For non-IP content";

    flow: to_server, established;
    http_header:field x-forwarded-for;

    # Detection of clearly non-IP content (special characters, non-hex letters)
    # Examples detected: test.example.com, user@domain.com, <script>, {"ip":"test"}
    # Simplified regex to detect obvious non-IP characters

    pcre:"/.*[g-zG-Z@<>{}\"'=]/i";

    classtype:HTTP_header_overflow;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245709;
    rev:1;
)

# ================================================================

alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (

    msg:"CVE-2025-22457 Heap spray pattern targeting Ivanti server";

    flow: to_server, established;
    http_header:field x-forwarded-for;
    pcre:"/.*?(\d)\1{49,}/i";
   
    classtype:Heap_spray_attack;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245703;
    rev:1;
)

# ================================================================


alert http $EXTERNAL_NET any -> $IVANTI_ADDR 80 (
    msg:"CVE-2025-22457 Memory address pattern 39393930 targeting Ivanti server";

    flow: to_server, established;
    http_header:field x-forwarded-for;
    content:"39393930";
   
    classtype:Ivanti_Policy_Secure--CVE-2025-22457;
    reference:cve,2025-22457;
    reference:url,https://github.com/TroutSoftware/eu-tis/issues/20;
    sid:2245704;
    rev:1;
)